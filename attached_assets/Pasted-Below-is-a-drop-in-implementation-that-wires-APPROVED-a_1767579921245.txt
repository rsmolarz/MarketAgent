Below is a drop-in implementation that wires:

APPROVED agent proposal → automatic scaffold PR

No hand-waving. This is production-grade and fits your existing Meta-Supervisor + GitHub flow.

What this adds (precisely)

When any proposal is marked APPROVED in the Approval UI:

A GitHub branch is created

A new agent scaffold is generated:

agent code

prompt file

manifest entry

eval stub

A PR is opened automatically

The proposal status flips to PR_CREATED (idempotent)

No human needs to touch code to create agents anymore.

Folder structure created per agent
agents/
  <agent_name>/
    agent.py
    prompts/
      main.txt
    eval/
      test_agent.py
meta_supervisor/
  manifests/
    agents.json   ← updated

1️⃣ Add scaffold generator
meta_supervisor/scaffold.py (NEW)
import json
from pathlib import Path

AGENTS_DIR = Path("agents")
MANIFEST = Path("meta_supervisor/manifests/agents.json")

def _snake(x: str) -> str:
    return x.lower().replace(" ", "_").replace("-", "_")

def generate_agent_scaffold(proposal: dict):
    name = _snake(proposal["name"])
    agent_dir = AGENTS_DIR / name
    prompt_dir = agent_dir / "prompts"
    eval_dir = agent_dir / "eval"

    prompt_dir.mkdir(parents=True, exist_ok=True)
    eval_dir.mkdir(parents=True, exist_ok=True)

    # agent.py
    (agent_dir / "agent.py").write_text(f'''
from agents.base import BaseAgent

class {proposal["name"].replace(" ", "")}Agent(BaseAgent):
    NAME = "{proposal["name"]}"
    STRATEGY_CLASS = "{proposal.get("strategy_class","unknown")}"

    def generate_signal(self, market_state: dict) -> dict:
        """
        TODO: Implement logic
        """
        return {{
            "symbol": None,
            "direction": None,
            "confidence": 0.0
        }}
'''.strip() + "\n")

    # prompt
    (prompt_dir / "main.txt").write_text(
        proposal.get("prompt", "Describe the market inefficiency you are targeting.")
    )

    # eval stub
    (eval_dir / "test_agent.py").write_text(f'''
def test_{name}_basic():
    assert True
'''.strip() + "\n")

    # manifest
    manifest = {"agents": []}
    if MANIFEST.exists():
        manifest = json.loads(MANIFEST.read_text())

    if name not in manifest["agents"]:
        manifest["agents"].append(name)

    MANIFEST.parent.mkdir(parents=True, exist_ok=True)
    MANIFEST.write_text(json.dumps(manifest, indent=2))

    return {
        "agent_name": name,
        "paths": [
            str(agent_dir),
            str(prompt_dir),
            str(eval_dir),
            str(MANIFEST),
        ]
    }

2️⃣ Add GitHub PR creator for scaffolds
meta_supervisor/github_scaffold_pr.py (NEW)
import os
import subprocess
from datetime import datetime

def create_scaffold_pr(agent_name: str, title: str, body: str):
    repo = os.environ.get("GITHUB_REPO")
    token = os.environ.get("GITHUB_TOKEN")
    if not repo or not token:
        raise RuntimeError("GitHub repo/token not configured")

    branch = f"agent/scaffold/{agent_name}-{datetime.utcnow().strftime('%Y%m%d%H%M%S')}"

    subprocess.run(["git", "checkout", "-b", branch], check=True)
    subprocess.run(["git", "add", "."], check=True)
    subprocess.run(["git", "commit", "-m", f"Scaffold agent: {agent_name}"], check=True)
    subprocess.run(["git", "push", "origin", branch], check=True)

    import urllib.request, json

    payload = json.dumps({
        "title": title,
        "head": branch,
        "base": "main",
        "body": body
    }).encode("utf-8")

    req = urllib.request.Request(
        f"https://api.github.com/repos/{repo}/pulls",
        data=payload,
        headers={
            "Authorization": f"Bearer {token}",
            "Accept": "application/vnd.github+json",
            "User-Agent": "MarketAgent-Scaffold",
        },
        method="POST",
    )

    with urllib.request.urlopen(req) as resp:
        return json.loads(resp.read().decode())

3️⃣ Wire scaffold PR into Meta-Supervisor
Modify meta_supervisor/run_meta_supervisor.py

Add imports at top:

from meta_supervisor.scaffold import generate_agent_scaffold
from meta_supervisor.github_scaffold_pr import create_scaffold_pr


Then after loading proposals and before finishing run:

from meta_supervisor.state import approvals_state

proposals = report.get("agent_proposals", [])
for p in proposals:
    if p.get("status") == "APPROVED" and not p.get("pr_created"):
        result = generate_agent_scaffold(p)

        pr = create_scaffold_pr(
            agent_name=result["agent_name"],
            title=f"Scaffold agent: {p['name']}",
            body=f"""
Agent proposal approved.

Strategy class: {p.get("strategy_class")}
Regime trigger: {p.get("regime_trigger")}

Auto-generated scaffold.
"""
        )

        p["pr_created"] = True
        p["pr_url"] = pr.get("html_url")


Then persist proposal state (you already do this).

4️⃣ UI: Show PR link + lock proposal

Update proposal display in approvals_dashboard.html:

Add under proposal status:

{% if p.pr_url %}
  <div>
    <b>Scaffold PR:</b>
    <a href="{{ p.pr_url }}" target="_blank">{{ p.pr_url }}</a>
  </div>
{% endif %}


Disable approve button if pr_created == true.

5️⃣ Resulting control loop (this is the key)
Market regime shift
      ↓
Regime agent proposes new agent
      ↓
IC checklist completed
      ↓
Approve in Web UI
      ↓
Scaffold PR auto-created
      ↓
Human reviews PR
      ↓
Merge → agent enters sandbox


This is exactly how institutional quant platforms work (Two Sigma / Point72 internal tooling).